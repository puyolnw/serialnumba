<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ทดสอบระบบใบประกาศ - Frontend</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'IBM Plex Sans Thai', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .test-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        .test-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 8px;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
            color: #155724;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
            color: #856404;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .api-info {
            background: #e9ecef;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-certificate"></i> ทดสอบระบบใบประกาศนียบัตร</h1>
            <p>ทดสอบการทำงานของระบบใบประกาศใน Frontend</p>
        </div>

        <!-- API Connection Test -->
        <div class="test-section">
            <h2><i class="fas fa-plug"></i> ทดสอบการเชื่อมต่อ API</h2>
            <p>ตรวจสอบการเชื่อมต่อกับ Backend API</p>
            <button class="test-button" onclick="testAPIConnection()">
                <i class="fas fa-wifi"></i> ทดสอบการเชื่อมต่อ
            </button>
            <div id="api-result" class="result" style="display: none;"></div>
        </div>

        <!-- Certificate Eligibility Test -->
        <div class="test-section">
            <h2><i class="fas fa-check-circle"></i> ทดสอบการตรวจสอบสิทธิ์ใบประกาศ</h2>
            <p>ทดสอบ API endpoint สำหรับตรวจสอบสิทธิ์การได้รับใบประกาศ</p>
            <button class="test-button" onclick="testCertificateEligibility()">
                <i class="fas fa-user-check"></i> ตรวจสอบสิทธิ์ (Mock)
            </button>
            <button class="test-button" onclick="testRealCertificateEligibility()">
                <i class="fas fa-database"></i> ตรวจสอบสิทธิ์ (Real Data)
            </button>
            <div id="eligibility-result" class="result" style="display: none;"></div>
        </div>

        <!-- Certificate Generation Test -->
        <div class="test-section">
            <h2><i class="fas fa-file-pdf"></i> ทดสอบการสร้างใบประกาศ</h2>
            <p>ทดสอบการสร้างและดาวน์โหลดใบประกาศ PDF</p>
            <button class="test-button" onclick="testCertificateGeneration()">
                <i class="fas fa-download"></i> สร้างใบประกาศ (Mock)
            </button>
            <button class="test-button" onclick="testRealMockCertificate()">
                <i class="fas fa-file-pdf"></i> สร้างใบประกาศ (Mock Data)
            </button>
            <button class="test-button" onclick="testRealCertificateGeneration()">
                <i class="fas fa-database"></i> ตรวจสอบข้อมูลจริง
            </button>
            <div id="generation-result" class="result" style="display: none;"></div>
        </div>

        <!-- Mock Data Test -->
        <div class="test-section">
            <h2><i class="fas fa-database"></i> ทดสอบข้อมูลจำลอง</h2>
            <p>ทดสอบการแสดงผลด้วยข้อมูลจำลอง</p>
            <button class="test-button" onclick="testMockData()">
                <i class="fas fa-play"></i> ทดสอบข้อมูลจำลอง
            </button>
            <div id="mock-result" class="result" style="display: none;"></div>
        </div>

        <!-- UI Components Test -->
        <div class="test-section">
            <h2><i class="fas fa-palette"></i> ทดสอบ UI Components</h2>
            <p>ทดสอบการแสดงผลของ UI components</p>
            <button class="test-button" onclick="testUIComponents()">
                <i class="fas fa-eye"></i> ทดสอบ UI
            </button>
            <div id="ui-result" class="result" style="display: none;"></div>
        </div>

        <!-- API Endpoints Info -->
        <div class="test-section">
            <h2><i class="fas fa-info-circle"></i> ข้อมูล API Endpoints</h2>
            <div class="api-info">
                <strong>Base URL:</strong> http://localhost:4000/api<br>
                <strong>Public Endpoints (ไม่ต้อง authentication):</strong><br>
                • GET /public/health - ตรวจสอบสถานะ server<br>
                • GET /public/user-hours/:userId - ดึงข้อมูลชั่วโมงของผู้ใช้<br>
                • GET /public/mock-certificate - สร้างใบประกาศด้วยข้อมูล Mock<br>
                <br>
                <strong>Protected Endpoints (ต้อง authentication):</strong><br>
                • GET /certificate/check-eligibility - ตรวจสอบสิทธิ์ใบประกาศ<br>
                • GET /certificate/generate/:userId - สร้างใบประกาศ PDF<br>
                <br>
                <strong>Mock Certificate Parameters:</strong><br>
                • name - ชื่อผู้รับใบประกาศ<br>
                • studentId - รหัสนักศึกษา<br>
                • hours - จำนวนชั่วโมงที่ทำ
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:4000/api';
        
        // Mock data for testing
        const mockEligibilityData = {
            success: true,
            data: {
                isEligible: true,
                totalHours: 120,
                requiredHours: 100,
                remainingHours: 0
            }
        };

        const mockIneligibleData = {
            success: true,
            data: {
                isEligible: false,
                totalHours: 75,
                requiredHours: 100,
                remainingHours: 25
            }
        };

        // Test API Connection
        async function testAPIConnection() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div class="loading"></div>กำลังทดสอบการเชื่อมต่อ...';
            const startTime = Date.now();

            try {
                // Try to connect to a simple endpoint first
                const response = await fetch(`${API_BASE_URL}/public/health`);
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <i class="fas fa-check-circle"></i> 
                        <strong>เชื่อมต่อสำเร็จ!</strong><br>
                        Status: ${data.status || 'OK'}<br>
                        Response Time: ${Date.now() - startTime}ms<br>
                        <small>Backend server กำลังทำงานปกติ</small>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>เชื่อมต่อล้มเหลว!</strong><br>
                    Error: ${error.message}<br>
                    <small>ตรวจสอบว่า Backend server กำลังรันอยู่ที่ port 4000</small>
                `;
            }
        }

        // Test Certificate Eligibility (Mock)
        async function testCertificateEligibility() {
            const resultDiv = document.getElementById('eligibility-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div class="loading"></div>กำลังตรวจสอบสิทธิ์...';

            // Use mock data directly
            setTimeout(() => {
                const isEligible = Math.random() > 0.5;
                const mockData = isEligible ? mockEligibilityData : mockIneligibleData;
                displayEligibilityResult(mockData, resultDiv);
            }, 1000);
        }

        // Test Certificate Eligibility (Real Data)
        async function testRealCertificateEligibility() {
            const resultDiv = document.getElementById('eligibility-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div class="loading"></div>กำลังตรวจสอบสิทธิ์จากฐานข้อมูลจริง...';

            try {
                // Get user ID from input or use default
                const userId = prompt('กรุณาใส่ User ID ที่ต้องการทดสอบ (หรือกด Cancel เพื่อใช้ ID = 1):') || '1';
                
                // Try to get real data from database
                const response = await fetch(`${API_BASE_URL}/public/user-hours/${userId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Simulate eligibility check
                    const requiredHours = 100; // Default required hours
                    const totalHours = data.totalHours || 0;
                    const isEligible = totalHours >= requiredHours;
                    
                    const eligibilityData = {
                        success: true,
                        data: {
                            isEligible,
                            totalHours,
                            requiredHours,
                            remainingHours: Math.max(requiredHours - totalHours, 0)
                        }
                    };
                    
                    displayEligibilityResult(eligibilityData, resultDiv);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>ไม่สามารถดึงข้อมูลจริงได้!</strong><br>
                    Error: ${error.message}<br>
                    <small>ตรวจสอบว่า Backend server กำลังรันและมีข้อมูลในฐานข้อมูล</small>
                `;
            }
        }

        // Test Mock Eligibility
        function testMockEligibility() {
            const resultDiv = document.getElementById('eligibility-result');
            const isEligible = Math.random() > 0.5;
            const mockData = isEligible ? mockEligibilityData : mockIneligibleData;
            displayEligibilityResult(mockData, resultDiv);
        }

        // Display Eligibility Result
        function displayEligibilityResult(data, resultDiv) {
            if (data.success) {
                const { isEligible, totalHours, requiredHours, remainingHours } = data.data;
                const progressPercent = Math.min((totalHours / requiredHours) * 100, 100);
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> 
                    <strong>ตรวจสอบสิทธิ์สำเร็จ!</strong><br><br>
                    <strong>สถานะ:</strong> ${isEligible ? 'มีสิทธิ์ได้รับใบประกาศ' : 'ยังไม่ครบชั่วโมง'}<br>
                    <strong>ชั่วโมงที่ทำ:</strong> ${totalHours} ชั่วโมง<br>
                    <strong>ชั่วโมงที่กำหนด:</strong> ${requiredHours} ชั่วโมง<br>
                    <strong>ชั่วโมงที่เหลือ:</strong> ${remainingHours} ชั่วโมง<br><br>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                    <small>ความคืบหน้า: ${progressPercent.toFixed(1)}%</small>
                `;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <i class="fas fa-times-circle"></i> 
                    <strong>เกิดข้อผิดพลาด!</strong><br>
                    ${data.message || 'ไม่สามารถตรวจสอบสิทธิ์ได้'}
                `;
            }
        }

        // Test Certificate Generation (Mock)
        async function testCertificateGeneration() {
            const resultDiv = document.getElementById('generation-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div class="loading"></div>กำลังสร้างใบประกาศจำลอง...';

            // Simulate PDF generation
            setTimeout(() => {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> 
                    <strong>สร้างใบประกาศจำลองสำเร็จ!</strong><br>
                    ขนาดไฟล์: 245.67 KB<br>
                    <small>นี่คือการทดสอบด้วยข้อมูลจำลอง</small><br>
                    <button class="test-button" onclick="alert('นี่คือการทดสอบจำลอง ไม่มีไฟล์จริง')" style="margin-top: 10px;">
                        <i class="fas fa-download"></i> ดาวน์โหลด PDF (Mock)
                    </button>
                `;
            }, 2000);
        }

        // Test Real Mock Certificate (สามารถดาวน์โหลด PDF จริงได้)
        async function testRealMockCertificate() {
            const resultDiv = document.getElementById('generation-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div class="loading"></div>กำลังสร้างใบประกาศด้วยข้อมูล Mock...';

            try {
                // Get custom data from user or use defaults
                const name = prompt('กรุณาใส่ชื่อ (หรือกด Cancel เพื่อใช้ชื่อเริ่มต้น):') || 'นายทดสอบ ระบบ';
                const studentId = prompt('กรุณาใส่รหัสนักศึกษา (หรือกด Cancel เพื่อใช้รหัสเริ่มต้น):') || 'TEST001';
                const hours = prompt('กรุณาใส่จำนวนชั่วโมง (หรือกด Cancel เพื่อใช้ 120 ชั่วโมง):') || '120';
                
                // Call mock certificate endpoint
                const response = await fetch(`${API_BASE_URL}/public/mock-certificate?name=${encodeURIComponent(name)}&studentId=${encodeURIComponent(studentId)}&hours=${hours}`);
                
                if (response.ok) {
                    // Create download link
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `mock_certificate_${studentId}.pdf`;
                    
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <i class="fas fa-check-circle"></i> 
                        <strong>สร้างใบประกาศสำเร็จ!</strong><br>
                        ชื่อ: ${name}<br>
                        รหัสนักศึกษา: ${studentId}<br>
                        ชั่วโมง: ${hours} ชั่วโมง<br>
                        ขนาดไฟล์: ${(blob.size / 1024).toFixed(2)} KB<br>
                        <button class="test-button" onclick="document.querySelector('#generation-result a').click()" style="margin-top: 10px;">
                            <i class="fas fa-download"></i> ดาวน์โหลด PDF
                        </button>
                    `;
                    resultDiv.appendChild(link);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>สร้างใบประกาศล้มเหลว!</strong><br>
                    Error: ${error.message}<br>
                    <small>ตรวจสอบว่า Backend server กำลังรันอยู่</small>
                `;
            }
        }

        // Test Real Certificate Generation (ตรวจสอบข้อมูลจริง)
        async function testRealCertificateGeneration() {
            const resultDiv = document.getElementById('generation-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div class="loading"></div>กำลังตรวจสอบข้อมูลจริง...';

            try {
                // Get user ID from input
                const userId = prompt('กรุณาใส่ User ID ที่ต้องการตรวจสอบ (หรือกด Cancel เพื่อใช้ ID = 1):') || '1';
                
                // First check if user is eligible
                const eligibilityResponse = await fetch(`${API_BASE_URL}/public/user-hours/${userId}`);
                
                if (!eligibilityResponse.ok) {
                    throw new Error(`ไม่พบข้อมูลผู้ใช้ ID: ${userId}`);
                }
                
                const eligibilityData = await eligibilityResponse.json();
                const totalHours = eligibilityData.data.totalHours || 0;
                const requiredHours = 100;
                
                if (totalHours < requiredHours) {
                    resultDiv.className = 'result warning';
                    resultDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>ยังไม่ครบชั่วโมงที่กำหนด!</strong><br>
                        ชั่วโมงที่ทำ: ${totalHours} ชั่วโมง<br>
                        ชั่วโมงที่กำหนด: ${requiredHours} ชั่วโมง<br>
                        ชั่วโมงที่เหลือ: ${requiredHours - totalHours} ชั่วโมง<br>
                        <small>ต้องทำครบชั่วโมงที่กำหนดก่อนจึงจะสร้างใบประกาศได้</small>
                    `;
                    return;
                }
                
                // Show real data
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <i class="fas fa-info-circle"></i> 
                    <strong>ข้อมูลจริงจากฐานข้อมูล</strong><br>
                    ผู้ใช้: ${eligibilityData.data.user.name}<br>
                    รหัสนักศึกษา: ${eligibilityData.data.user.student_id || 'ไม่ระบุ'}<br>
                    อีเมล: ${eligibilityData.data.user.email}<br>
                    ชั่วโมงที่ทำ: ${totalHours} ชั่วโมง<br>
                    <small>ข้อมูลนี้มาจากฐานข้อมูลจริง</small><br>
                    <button class="test-button" onclick="testRealMockCertificate()" style="margin-top: 10px;">
                        <i class="fas fa-file-pdf"></i> สร้างใบประกาศด้วยข้อมูลนี้
                    </button>
                `;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>ไม่สามารถดึงข้อมูลได้!</strong><br>
                    Error: ${error.message}<br>
                    <small>ตรวจสอบว่า Backend server กำลังรันและมีข้อมูลในฐานข้อมูล</small>
                `;
            }
        }

        // Test Mock Data
        function testMockData() {
            const resultDiv = document.getElementById('mock-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result success';
            
            const mockData = {
                student: {
                    name: 'นายทดสอบ ระบบ',
                    studentId: 'TEST001',
                    totalHours: 120,
                    requiredHours: 100
                },
                activities: [
                    { title: 'กิจกรรมทดสอบ 1', hours: 20, date: '2024-01-15' },
                    { title: 'กิจกรรมทดสอบ 2', hours: 30, date: '2024-01-20' },
                    { title: 'กิจกรรมทดสอบ 3', hours: 25, date: '2024-01-25' },
                    { title: 'กิจกรรมทดสอบ 4', hours: 45, date: '2024-02-01' }
                ]
            };

            resultDiv.innerHTML = `
                <i class="fas fa-check-circle"></i> 
                <strong>ข้อมูลจำลอง</strong><br><br>
                <strong>ข้อมูลนักเรียน:</strong><br>
                • ชื่อ: ${mockData.student.name}<br>
                • รหัสนักศึกษา: ${mockData.student.studentId}<br>
                • ชั่วโมงที่ทำ: ${mockData.student.totalHours} ชั่วโมง<br>
                • ชั่วโมงที่กำหนด: ${mockData.student.requiredHours} ชั่วโมง<br><br>
                <strong>กิจกรรมที่เข้าร่วม:</strong><br>
                ${mockData.activities.map(activity => 
                    `• ${activity.title} - ${activity.hours} ชั่วโมง (${activity.date})`
                ).join('<br>')}
            `;
        }

        // Test UI Components
        function testUIComponents() {
            const resultDiv = document.getElementById('ui-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result success';
            
            resultDiv.innerHTML = `
                <i class="fas fa-check-circle"></i> 
                <strong>ทดสอบ UI Components</strong><br><br>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="test-button" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <i class="fas fa-check"></i> Success Button
                    </button>
                    <button class="test-button" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                        <i class="fas fa-times"></i> Error Button
                    </button>
                    <button class="test-button" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
                        <i class="fas fa-exclamation"></i> Warning Button
                    </button>
                </div>
                <br>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 75%"></div>
                </div>
                <small>Progress Bar Test - 75%</small>
            `;
        }

        // Auto-run API connection test on page load
        window.addEventListener('load', () => {
            setTimeout(testAPIConnection, 1000);
        });
    </script>
</body>
</html>
